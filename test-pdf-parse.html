<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Parse Debug Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .log {
      background: #000;
      padding: 10px;
      border: 1px solid #00ff00;
      margin: 10px 0;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: #00ff00;
      color: #000;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin: 10px 5px;
    }
    button:hover {
      background: #00cc00;
    }
    .error { color: #ff0000; }
    .success { color: #00ff00; }
    .warning { color: #ffaa00; }
    input {
      width: 400px;
      padding: 8px;
      margin: 10px 0;
      background: #000;
      color: #00ff00;
      border: 1px solid #00ff00;
    }
    h1 { color: #00ff00; }
    h2 { color: #00ff00; margin-top: 30px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>üêõ PDF Parse Debug Test</h1>

  <div>
    <h2>Step 1: Login</h2>
    <input type="email" id="email" placeholder="Email" value="operator@travel.com">
    <input type="password" id="password" placeholder="Password" value="operator123">
    <button onclick="login()">Login</button>
  </div>

  <div>
    <h2>Step 2: Test Parse PDF</h2>
    <input type="text" id="pdfUrl" placeholder="PDF URL" value="https://huaaogdxxdcakxryecnw.supabase.co/storage/v1/object/public/travel-documents/test.pdf">
    <button onclick="testParse()">Test Parse PDF</button>
  </div>

  <div>
    <h2>Logs:</h2>
    <div id="logs"></div>
  </div>

  <script>
    const supabaseUrl = 'https://huaaogdxxdcakxryecnw.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1YWFvZ2R4eGRjYWt4cnllY253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDY2OTAsImV4cCI6MjA3OTI2NjY5MH0.ygqwQNOpbJqe9NHtlxLCIlmVk2j5Mkcw4qvMpkGyeY0';

    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
    let session = null;

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = `log ${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    async function login() {
      log('üîê Logging in...');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          log(`‚ùå Login failed: ${error.message}`, 'error');
          return;
        }

        session = data.session;
        log(`‚úÖ Login successful!`, 'success');
        log(`   User ID: ${data.user.id}`);
        log(`   Token: ${session.access_token.substring(0, 50)}...`);
      } catch (err) {
        log(`‚ùå Login error: ${err.message}`, 'error');
      }
    }

    async function testParse() {
      if (!session) {
        log('‚ùå Please login first!', 'error');
        return;
      }

      const pdfUrl = document.getElementById('pdfUrl').value;
      log(`ü§ñ Testing parse-trip-pdf function...`);
      log(`   PDF URL: ${pdfUrl}`);

      try {
        const startTime = Date.now();

        log(`üì° Sending request...`);
        const response = await fetch(
          `${supabaseUrl}/functions/v1/parse-trip-pdf`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`,
            },
            body: JSON.stringify({ pdfUrl }),
          }
        );

        const duration = Date.now() - startTime;
        log(`üìä Response received in ${duration}ms`);
        log(`   Status: ${response.status} ${response.statusText}`);
        log(`   Content-Type: ${response.headers.get('Content-Type')}`);
        log(`   CORS: ${response.headers.get('Access-Control-Allow-Origin')}`);

        const responseText = await response.text();

        if (response.ok) {
          log(`‚úÖ Success!`, 'success');
          const data = JSON.parse(responseText);
          log(`üì¶ Response data:\n${JSON.stringify(data, null, 2)}`);

          if (data.debug) {
            log(`üêõ Debug Info:`, 'warning');
            log(`   Request ID: ${data.debug.requestId}`);
            log(`   User ID: ${data.debug.userId}`);
            log(`   Processing time: ${data.debug.processingTime}`);
          }
        } else {
          log(`‚ùå Request failed with status ${response.status}`, 'error');
          log(`   Response: ${responseText.substring(0, 500)}`);
        }

      } catch (err) {
        log(`‚ùå Fetch error: ${err.message}`, 'error');
        log(`   Error name: ${err.name}`);
        log(`   Error stack:\n${err.stack}`, 'error');

        if (err.cause) {
          log(`   Cause: ${err.cause}`, 'error');
        }

        log(`\nüí° This "Failed to fetch" usually means:`, 'warning');
        log(`   1. CORS is blocking the request (check browser console)`, 'warning');
        log(`   2. Network error or timeout`, 'warning');
        log(`   3. Function is not responding`, 'warning');
        log(`   4. Browser security policy blocking`, 'warning');
      }
    }

    log('üü¢ Ready to test! Please login first.');
  </script>
</body>
</html>
